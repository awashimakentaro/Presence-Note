# Presence Note – 詳細設計書（Code-Oriented Design）

## 0. 設計思想（最上位原則）

- 本システムは「通知装置」ではない
- 本システムは「記録装置」ではない
- 本システムは「最適化装置」ではない

Presence Note は、
相手に何も要求せず、
ただ「思われていた」という事実だけを
物理的な痕跡として残すための装置である。

技術は目的ではなく、沈黙を守るための手段である。

---

## 1. システム全体構成
```
[Sender]
   |
   | (image)
   v
[ ntfy ]  -- 搬送路（意味を持たない）
   |
   v
[ Raspberry Pi ]
   |
   | USB / CUPS
   v
[ Canon SELPHY CP1500 ]
   |
   v
[ 54mm x 86mm Printed Photo ]
   |
   v
[ Recipient inserts into Cheki Holder ]
```
---

## 2. 設計方針（確定事項）

- 単一 Raspberry Pi
- 単一プロセス
- 直列処理
- 非同期・キュー・再送なし
- ntfy は単なる搬送路
- 正常時は沈黙
- 節目のみ独り言
- データは履歴として保持
- 成功／失敗を評価しない

---

## 3. ディレクトリ構成
```
presence-note/
apps/
├── main.py # 装置の振る舞いを記述する唯一の入口
├── config.py # 定数・設定値のみを定義
├── receiver.py # ntfy からの画像受信
├── image_processor.py # 写真＋一言の合成処理
├── printer.py # 印刷制御（CUPS）
├── storage.py # 履歴保存
├── logger.py # 最低限の独り言
└── history/
      └── YYYY-MM-DD/ # 日付単位での履歴保存
```
---
   
## 4. 各ファイルの責務と関数定義

### 4.1 main.py

**責務**
- 装置全体の振る舞いを直列で記述する
- 判断しない
- 騒がない

```python
def main():
    """
    起動後、以下を直列に実行する。

    1. ntfy から画像を1件受信
    2. 印刷用画像を生成
    3. 印刷を実行
    4. 履歴として保存

    途中で失敗しても、
    それを世界に伝えない。
    """
```

### 4.2 config.py

責務

環境依存情報を集約

ロジックを持たない

```python
NTFY_TOPIC_URL: str
PRINTER_NAME: str
OUTPUT_SIZE_MM = (54, 86)
DPI: int
HISTORY_DIR: str
```

### 4.3 receiver.py

**責務**

ntfy から画像を受信する

内容を解釈しない

成功可否を評価しない

```python
def wait_for_image() -> bytes:
    """
    ntfy を購読し、
    画像データを1件受信する。

    画像の意味・内容には関与しない。
    """
```

### 4.4 image_processor.py

**責務**

写真を 54mm x 86mm に整形

写真＋一言を合成

感情分析・自動生成を行わない

```python
def compose_image(photo_bytes: bytes, text: str) -> Image:
    """
    写真と一言を合成し、
    印刷用の最終画像を生成する。

    一言は短く、
    読み切り1秒以内であることを前提とする。
    """
```

### 4.5 printer.py

**責務**

印刷という行為だけを担当

成功・失敗を判断しない

再送しない

```python
def print_image(image_path: str) -> None:
    """
    CUPS 経由でプリンタに印刷指示を出す。
    結果は評価しない。
    """
```
### 4.6 storage.py

**責務**

印刷後のデータを履歴として保存

検索・参照・分析は行わない

```python
def save_history(image_path: str, metadata: dict) -> None:
    """
    印刷された画像と最低限の情報を
    日付単位で保存する。

    保存された履歴は、
    原則として参照されない。
    """
```
### 4.7 logger.py

**責務**

装置の「節目」だけを独り言として出力

```python
def log_event(message: str) -> None:
    """
    起動、印刷開始、印刷終了など、
    節目のみを静かに出力する。
    """
```

### 5. 明示的に「やらないこと」

非同期処理

キュー管理

再送制御

既読・確認

成功率の計測

利用頻度の最適化

感情・関係性の分析

### 6. 設計の最終定義

この設計は、

装置を賢くしない

意味を後付けしない

世界を説明しない

ことを守るために存在する。

Presence Note は、
動作するシステムである前に、
沈黙を保つ存在である。

---